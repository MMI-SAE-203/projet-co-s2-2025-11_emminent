---
import Layout from "../../layouts/Layoutappli.astro";

export const prerender = false;
const locals = Astro.locals;

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const email = data.get("email") as string;
        const password = data.get("password") as string;

        await locals.pb.collection("users").authWithPassword(email, password);
        return Astro.redirect("/appli/profil");
    } catch (e) {
        console.error(e);
    }
}
---

<Layout pageTitle="Connexion">
    <main class="max-w-md mx-auto py-16 text-white">
        <h1 class="text-4xl font-bold mb-8 text-center">Connexion</h1>
        <form method="POST" class="space-y-6">
            <label class="block">
                <span class="block mb-1">Adresse e-mail</span>
                <input
                    class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-600 text-white"
                    type="email"
                    name="email"
                    required
                />
            </label>
            <label class="block">
                <span class="block mb-1">Mot de passe</span>
                <input
                    class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-600 text-white"
                    type="password"
                    name="password"
                    required
                />
            </label>
            <input
                class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-semibold py-2 rounded cursor-pointer"
                type="submit"
                value="Se connecter"
            />
        </form>

        <div class="mt-6 flex justify-between items-center">
            <a
                href="/appli/register"
                class="text-sm text-blue-400 hover:underline"
            >
                Pas encore de compte ?
            </a>
        </div>

        {
            locals.pb.authStore.record ? (
                <p class="mt-6 text-center text-sm text-green-400">
                    Connect√© en tant que {locals.pb.authStore.record.email}
                </p>
            ) : null
        }
    </main>
</Layout>

<script>
    import { pb } from "../../utils/server.ts";

    const loginButton = document.getElementById("login-gh");
    if (loginButton) {
        loginButton.addEventListener("click", loginWithGithub);
    }

    async function loginWithGithub() {
        await pb.collection("users").authWithOAuth2({ provider: "github" });
        document.cookie = pb.authStore.exportToCookie({ httpOnly: false });
        window.location.href = "/profil";
    }
</script>
